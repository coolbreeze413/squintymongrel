<!DOCTYPE html>
<!-- references -->
<!-- AMD/ESM: 
  https://dev.to/iggredible/what-the-heck-are-cjs-amd-umd-and-esm-ikm
  https://requirejs.org/docs/whyamd.html
-->
<!-- read local file in JS: 
  https://developer.mozilla.org/en-US/docs/Web/API/File_API/Using_files_from_web_applications
  https://stackoverflow.com/a/29176118/3379867
  https://www.geeksforgeeks.org/how-to-read-a-local-text-file-using-javascript/
-->
<!-- find file extension in JS
  https://www.w3docs.com/snippets/javascript/how-to-get-file-extensions-with-javascript.html
-->
<!-- locally use monaco-editor without node.js: https://stackoverflow.com/questions/62099902/how-to-use-monaco-editor-without-node-js -->
<!-- tabs, single instance: https://github.com/microsoft/monaco-editor/issues/604#issuecomment-344214706 -->
<!-- experimental monaco with filetree, tabs, filemanagement: https://github.com/bootrino/reactoxide -->
<!-- createModel refs: https://snyk.io/advisor/npm-package/monaco-editor/functions/monaco-editor.editor.createModel -->
<!-- download monaco-editor tgz: 
  https://registry.npmjs.org/monaco-editor/-/monaco-editor-0.30.0.tgz
  https://www.npmjs.com/package/monaco-editor?activeTab=versions
-->
<!-- Qt + WebEngine + HTML + JS
  https://stackoverflow.com/questions/64164738/how-to-embed-basic-html-page-using-qt
  https://stackoverflow.com/questions/64194768/how-to-get-and-set-the-value-of-monaco-editor-in-python-qt
-->

<html>

<head>
  <title>Monaco Editor</title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <link rel="stylesheet" data-name="vs/editor/editor.main"
    href="./monaco-editor/dev/vs/editor/editor.main.css" />
</head>

<body>
  <h2>Monaco Editor</h2>

  <div id='fileselect'>
  Select File >> <input type='file' onchange='readFileFromInputUsingFileReader(event)' style='min-width:200px;'>
  </div>

  <br/>

  <button onclick="clicky()" style='min-width:200px;'> clicky </button>

  <br/>

  <div id='output'></div>

  <br/>

  <div id='file_selected'></div>

  <br/>

  <div id='language_detected'></div>

  <br/>

  <div id="container" style="min-width: 800px; min-height: 600px; border: 1px solid grey"></div>

  <script>
    var require = { paths: { vs: './monaco-editor/dev/vs' } };
  </script>
  <script src="./monaco-editor/dev/vs/loader.js"></script>
  <script src="./monaco-editor/dev/vs/editor/editor.main.nls.js"></script>
  <script src="./monaco-editor/dev/vs/editor/editor.main.js"></script>


  <script>
    // load default content on startup.
    var monacoEditor = monaco.editor.create(document.getElementById('container'), {
      value: [
        '#include <iostream>',
        '',
        'int main() {',
        'std::cout << "hello" << std::endl;',
        'return 0;',
        '}'
      ].join('\n'),
      language: 'cpp',
      automaticLayout: true,
      theme: "vs"
    });

    document.getElementById('file_selected').innerText = 'file selected: ' + 'internal-sample-code';
    document.getElementById('language_detected').innerText = 'language detected: ' + 'cpp';

  </script>
  
  <script>
    function getModelLanguage(path) {
      // include the dot in the extension!
      var ext = path.substring(path.lastIndexOf('.'));
      console.log("found extension: " + ext);
      
      const language = monaco
        .languages
        .getLanguages()
        .find((lang) => {
          // check the condition that will yield truthy
          if( (lang.extensions) && (lang.extensions.indexOf(ext) != -1) ) {
            return true;
          }
        });
      
      // console.log("found language:");
      // console.log(language);
      
      return language ? language.id : 'plaintext';
    }

    function readFileFromInputUsingFileReader(event) {
      var _input = event.target;
      var _filepath = _input.files[0];
      window.cppEndPoint.log("openFileFromInput: " + _filepath);
      
      var language_id = getModelLanguage(_filepath.name)

      var reader = new FileReader();
      reader.onload = function() {
        var text = reader.result;
        
        document.getElementById('file_selected').innerText = 'file selected: ' + _filepath.name;
        document.getElementById('language_detected').innerText = 'language detected: ' + language_id;
        
        monaco.editor.getModels().forEach(model => model.dispose());
        var model = monaco.editor.createModel(value=text, language=language_id);
        monacoEditor.setModel(model);
      };
    
      reader.readAsText(_filepath);
    };

    // https://stackoverflow.com/questions/14446447/how-to-read-a-local-text-file-in-the-browser
    function readFileFromPathUsingXHR(filepath) {
      var rawFile = new XMLHttpRequest();
      rawFile.open("GET", filepath, false);
      rawFile.onreadystatechange = function () {
        if(rawFile.readyState === 4)  {
          if(rawFile.status === 200 || rawFile.status == 0) {
            var text = rawFile.responseText;
            
            var language_id = getModelLanguage(filepath)
            
            document.getElementById('file_selected').innerText = 'file selected: ' + filepath;
            document.getElementById('language_detected').innerText = 'language detected: ' + language_id;
            
            monaco.editor.getModels().forEach(model => model.dispose());
            var model = monaco.editor.createModel(value=text, language=language_id);
            monacoEditor.setModel(model);
          }
        }
      }
      rawFile.send(null);
    }


    // https://stackoverflow.com/questions/14446447/how-to-read-a-local-text-file-in-the-browser
    function readFileFromPathUsingFetch(filepath) {
      fetch(filepath)
      .then((res) => res.text())
      .then((text) => {
        var language_id = getModelLanguage(filepath);
        
        document.getElementById('file_selected').innerText = 'file selected: ' + filepath;
        document.getElementById('language_detected').innerText = 'language detected: ' + language_id;
        
        monaco.editor.getModels().forEach(model => model.dispose());
        var model = monaco.editor.createModel(value=text, language=language_id);
        monacoEditor.setModel(model);
      })
      .catch((e) => console.error(e));
    }
  </script>

  <!-- <script type="text/javascript" src="qrc:///qtwebchannel/qwebchannel.js"></script> -->
  <script type="text/javascript" src="./qwebchannel.js"></script>
  <script type="text/javascript">
    window.webChannel = new QWebChannel(qt.webChannelTransport, function (channel) {
      // alert("QWebChannel created!")
      window.cppEndPoint = channel.objects.CPPEndPoint;
      window.cppEndPoint.log("QWebChannel created!");

      // alert("we got intValue: " + window.cppEndPoint.intValue);
      window.cppEndPoint.log("we got intValue: " + window.cppEndPoint.intValue);

      window.cppEndPoint.updateFilePath.connect(function(path) {
        // alert(path);
        readFileFromPathUsingXHR(path);
        // readFileFromPathUsingFetch(path); // -> won't work as: Fetch API cannot load ... URL scheme "file" is not supported.
      })
    });
  </script>

  <script>
    function appVersionCallbackFunction(appversion) {
      // alert("we got the App Version: " + appversion);
     window.cppEndPoint.log("we got the App Version: " + appversion);
    }

    function clicky() {
      window.cppEndPoint.log("clicky() says -->> get me the App Version!");
      window.cppEndPoint.getAppVersion(appVersionCallbackFunction);
    }
  </script>
</body>

</html>